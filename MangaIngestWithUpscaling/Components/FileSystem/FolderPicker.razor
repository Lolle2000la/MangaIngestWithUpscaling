@inherits ReactiveInjectableComponentBase<FolderPickerViewModel>
@using System.IO
@using MudBlazor

@inject FolderPickerViewModel viewModel

<MudPaper Class="pa-4" Elevation="5">
    <MudStack Row="true">
        <MudText Typo="Typo.h6" Class="mb-4">
            @ViewModel?.Title

            @if (Required)
            {
                <MudText Typo="Typo.inherit" Class="ml-1" Color="Color.Error">*</MudText>
            }
        </MudText>
    </MudStack>

    <MudStack Row="true" AlignItems="AlignItems.Baseline">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Current Path: </MudText>
        <MudInputString @bind-Value="ViewModel!.RootDirectory" Class="mb-2 flex-grow-1" FullWidth="true" />
    </MudStack>

    @if (ViewModel?.ErrorMessage != null)
    {
        <MudAlert Severity="Severity.Error">@ViewModel.ErrorMessage</MudAlert>
    }

    <MudPaper Elevation="2">
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Outlined" OnClick="async (e) => await ViewModel?.GoToParentCommand.Execute()" Disabled="@(!ViewModel?.CanGoToParent ?? true)">
                Go to Parent
            </MudButton>
            <MudSpacer />
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="async (e) => await ViewModel?.LoadDirectoryItemsCommand.Execute()">
                <MudIcon Icon="@Icons.Material.Filled.Refresh" /> Refresh
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudTreeView T="DirectoryItem" ServerData="@ViewModel!.HandleExpand" Items="@ViewModel?.TreeItems" Activatable="true"
                 Hover="true" Loading="@ViewModel?.Loading" MaxHeight="20rem"
                 SelectionMode="SelectionMode.SingleSelection"
                 SelectedValueChanged="v => ViewModel!.SelectedPath = v.Path">
        <ItemTemplate>
            <MudTreeViewItem T="DirectoryItem" @key="context.Value?.Path" Value="@context.Value" Text="@context.Value?.Name"
                             Icon="@Icons.Material.Filled.FolderOpen"
                             ItemsChanged="@(new Action<IReadOnlyCollection<TreeItemData<DirectoryItem>>>(items => ViewModel?.HandleItemsLoaded(context, items)))"
                             CanExpand="@context.Expandable"
                             @bind-Expanded="@context.Expanded"
                             Items="@context.Children"
                             OnDoubleClick="@(() => ViewModel!.RootDirectory = context.Value?.Path)" />
        </ItemTemplate>
    </MudTreeView>
    <MudStack Row="true" AlignItems="AlignItems.Center">

        <MudText Typo="Typo.subtitle2" Class="mb-2">Selected Folder:</MudText>
        <MudInputString Required="@Required" Value="@ViewModel?.SelectedPath"
                        Class="flex-grow-1" ReadOnly="true" />
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public bool Required { get; set; } = false;

    [Parameter]
    public string RootDirectory
    {
        get => ViewModel?.RootDirectory ?? Path.GetPathRoot(Path.GetFullPath("."));
        set => ViewModel!.RootDirectory = value;
    }

    [Parameter]
    public string SelectedPath
    {
        get => ViewModel?.SelectedPath ?? "";
        set
        {
            if (ViewModel != null)
            {
                ViewModel.SelectedPath = value;
            }
        }
    }

    [Parameter]
    public EventCallback<string> SelectedPathChanged { get; set; }

    [Parameter]
    public string Title
    {
        get => ViewModel?.Title ?? "";
        set => ViewModel!.Title = value;
    }

    protected override void OnInitialized()
    {
        this.WhenActivated(disposables =>
        {
            Console.WriteLine("FolderPicker Activated");
            ViewModel!.WhenPathSelected
                .Subscribe(path => SelectedPathChanged.InvokeAsync(path))
                .DisposeWith(disposables);
        });
        base.OnInitialized();
    }
}
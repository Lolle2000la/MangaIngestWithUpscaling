@page "/mangas/{MangaId:int}"
@using MangaIngestWithUpscaling.Components.MangaManagement.Chapters
@using MangaIngestWithUpscaling.Data.LibraryManagement
@using MangaIngestWithUpscaling.Services.MetadataHandling
@using MangaIngestWithUpscaling.Shared.Data.LibraryManagement

@inject ApplicationDbContext DbContext
@inject IMangaMetadataChanger MetadataChanger
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ILogger<EditManga> Logger
@inject IStringLocalizer<SharedResource> Loc

@if (manga is not null)
{
    <PageTitle>@string.Format(Loc["EditManga_PageTitle"], manga.PrimaryTitle)</PageTitle>

    <MudStack>
        <!-- Header -->
        <MudPaper Elevation="2" Class="pa-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudTooltip Text="@Loc["EditManga_Tooltip_Back"]">
                    <MudIconButton Href="mangas" Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary"
                        Size="Size.Large" />
                </MudTooltip>
                <div>
                    <MudText Typo="Typo.h4" Class="mb-1">@Loc["EditManga_Header_EditManga"]</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Surface">"@manga.PrimaryTitle"</MudText>
                </div>
                <MudSpacer />
                <MudChip T="string" Color="Color.Info" Variant="Variant.Text">
                    @string.Format(Loc["EditManga_Chip_Library"], manga.Library.Name)
                </MudChip>
            </MudStack>
        </MudPaper>

        <!-- Tabbed Interface -->
        <MudForm @ref="form" @bind-IsValid="isValid" @bind-IsTouched="isTouched">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">

                <!-- Basic Information Tab -->
                <MudTabPanel Text="@Loc["EditManga_Tab_BasicInfo"]" Icon="@Icons.Material.Filled.Info">
                    <MudGrid Spacing="4">
                        <MudItem xs="12">
                            <MudText Typo="Typo.h5" GutterBottom="true">
                                <MudIcon Icon="@Icons.Material.Filled.Title" Class="mr-2" />
                                @Loc["EditManga_Header_BasicInfo"]
                            </MudText>
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField Label="@Loc["EditManga_Label_PrimaryTitle"]" @bind-Value="manga.PrimaryTitle"
                                Immediate="true" Variant="Variant.Outlined"
                                HelperText="@Loc["EditManga_Helper_PrimaryTitle"]" Required />
                            <MudCheckBox T="bool" Label="@Loc["EditManga_Label_AddOldTitle"]"
                                @bind-Value="addOldTitleToOtherTitles" Size="Size.Small" Class="mt-2" />
                        </MudItem>

                        <MudItem md="6" xs="12">
                            <MudSelect T="int?" Label="@Loc["EditManga_Label_UpscalerProfile"]"
                                @bind-Value="manga.UpscalerProfilePreferenceId"
                                HelperText="@Loc["EditManga_Helper_UpscalerProfile"]" Variant="Variant.Outlined">
                                <MudSelectItem T="int?" Value="@((int?)null)">@Loc["EditManga_Option_None"]</MudSelectItem>
                                @foreach (var profile in upscalerProfiles)
                                {
                                    <MudSelectItem T="int?" Value="@profile.Id">@profile.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem md="6" xs="12">
                            <MudSelect T="bool?" Label="@Loc["EditManga_Label_ChapterMerging"]"
                                @bind-Value="manga.MergeChapterParts" HelperText="@Loc["EditManga_Helper_ChapterMerging"]"
                                Variant="Variant.Outlined">
                                <MudSelectItem T="bool?" Value="@((bool?)null)">@Loc["EditManga_Option_Default"]
                                </MudSelectItem>
                                <MudSelectItem T="bool?" Value="@true">@Loc["EditManga_Option_AlwaysMerge"]</MudSelectItem>
                                <MudSelectItem T="bool?" Value="@false">@Loc["EditManga_Option_NeverMerge"]</MudSelectItem>
                            </MudSelect>
                            <MudText Typo="Typo.caption" Color="Color.Warning" Class="mt-1">
                                @Loc["EditManga_Warning_Experimental"]
                            </MudText>
                        </MudItem>

                        <MudItem xs="12">
                            <MudDivider Style="margin: 16px 0;" />
                            <MudStack Row Spacing="4" Class="mt-2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @Loc["EditManga_Label_Created"] @manga.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @Loc["EditManga_Label_Modified"] @manga.ModifiedAt.ToString("yyyy-MM-dd HH:mm")
                                </MudText>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Alternative Titles Tab -->
                <MudTabPanel Text="@Loc["EditManga_Tab_AltTitles"]" Icon="@Icons.Material.Filled.Title">
                    <MudGrid Spacing="4">
                        <MudItem xs="12">
                            <MudText Typo="Typo.h5" GutterBottom="true">
                                <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" />
                                @Loc["EditManga_Header_AltTitles"]
                            </MudText>
                            <MudText Typo="Typo.body1" Color="Color.Surface" Class="mb-4">
                                @Loc["EditManga_Body_AltTitles"]
                            </MudText>
                        </MudItem>

                        <MudItem xs="12">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" Class="mb-3">@Loc["EditManga_Header_AddNewTitle"]</MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End">
                                    <MudTextField Label="@Loc["EditManga_Label_AltTitle"]" @bind-Value="newTitle"
                                        Immediate="true" Class="flex-grow-1" @ref="newTitleField" Variant="Variant.Outlined"
                                        HelperText="@Loc["EditManga_Helper_AltTitle"]" />
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled"
                                        Color="Color.Primary" Disabled="string.IsNullOrWhiteSpace(newTitle)"
                                        OnClick="_ => AddAlternativeTitle()" Class="flex-shrink-0">
                                        @Loc["EditManga_Button_AddTitle"]
                                    </MudButton>
                                </MudStack>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12">
                            <MudText Typo="Typo.h6" Class="mb-3">@Loc["EditManga_Header_CurrentTitles"]</MudText>
                            @if (!manga.OtherTitles.Any())
                            {
                                <MudPaper Elevation="0" Class="pa-4 text-center"
                                    Style="border: 2px dashed var(--mud-palette-lines-inputs);">
                                    <MudIcon Icon="@Icons.Material.Filled.Title" Size="Size.Large" Color="Color.Surface"
                                        Class="mb-2" />
                                    <MudText Typo="Typo.body1" Color="Color.Surface">@Loc["EditManga_Text_NoTitles"]
                                    </MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">@Loc["EditManga_Text_AddTitlesHelp"]
                                    </MudText>
                                </MudPaper>
                            }
                            else
                            {
                                <MudList T="MangaAlternativeTitle" @ref="titlesList" @bind-SelectedValues="selectedTitles">
                                    @foreach (var title in manga.OtherTitles.OrderBy(t => t.Title))
                                    {
                                        <MudListItem Value="@title">
                                            <MudPaper Elevation="1" Class="pa-3">
                                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                                    <MudIcon Icon="@Icons.Material.Filled.Label" Color="Color.Primary"
                                                        Class="mr-2" />
                                                    <MudText Typo="Typo.body1" Class="flex-grow-1">@title.Title</MudText>
                                                    <MudTooltip Text="@Loc["EditManga_Tooltip_RemoveTitle"]">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                                            Size="Size.Small" OnClick="() => manga.OtherTitles.Remove(title)" />
                                                    </MudTooltip>
                                                </MudStack>
                                            </MudPaper>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Chapters Management Tab -->
                <MudTabPanel Text="@Loc["EditManga_Tab_Chapters"]" Icon="@Icons.Material.Filled.MenuBook">
                    <MudGrid Spacing="4">
                        <MudItem xs="12">
                            <MudText Typo="Typo.h5" GutterBottom="true">
                                <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="mr-2" />
                                @Loc["EditManga_Header_ChapterManagement"]
                            </MudText>
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-4">
                                <div>
                                    <MudText Typo="Typo.body2">
                                        @((MarkupString)Loc["EditManga_Warning_DeleteChapter"].Value)
                                    </MudText>
                                    <MudText Typo="Typo.body2">
                                        @Loc["EditManga_Text_CannotUndo"]
                                    </MudText>
                                </div>
                            </MudAlert>
                        </MudItem>

                        <MudItem xs="12">
                            <ChapterList Manga="manga" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudForm>

        <!-- Action Buttons -->
        <MudPaper Elevation="2" Class="pa-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Color="Color.Surface">
                    @if (isTouched)
                    {
                        <text>@Loc["EditManga_Text_UnsavedChanges"]</text>
                    }
                    else
                    {
                        <text>@Loc["EditManga_Text_NoChanges"]</text>
                    }
                </MudText>

                <MudStack Row="true" Spacing="2">
                    <MudButton Href="mangas" StartIcon="@Icons.Material.Filled.Cancel" Variant="Variant.Text"
                        Color="Color.Default">
                        @Loc["EditManga_Button_Cancel"]
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Save" Variant="Variant.Filled" Color="Color.Primary"
                        OnClick="Save" Disabled="@(!isTouched || !isValid)">
                        @Loc["EditManga_Button_SaveChanges"]
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudStack>
}
else
{
    <MudText Typo="Typo.h4">Loading...</MudText>
}

@code {
    [Parameter] public required int MangaId { get; set; }

    private Manga? manga;
    private bool isValid;
    private bool isTouched;
    private string originalTitle = string.Empty;
    private string newTitle = string.Empty;
    private bool addOldTitleToOtherTitles = true;
    private List<UpscalerProfile> upscalerProfiles = [];

    private IReadOnlyCollection<MangaAlternativeTitle>? selectedTitles;

    private MudForm form = default!;
    private MudList<MangaAlternativeTitle> titlesList = default!;
    private MudTextField<string> newTitleField = default!;

    protected override async Task OnInitializedAsync()
    {
        manga = await DbContext.MangaSeries
        .Include(m => m.Library)
        .Include(m => m.Chapters)
        .ThenInclude(c => c.UpscalerProfile)
        .Include(m => m.OtherTitles)
        .Include(m => m.UpscalerProfilePreference)
        .FirstOrDefaultAsync(m => m.Id == MangaId);

        if (manga == null)
        {
            NavigationManager.NavigateTo("/mangas");
            return;
        }

        originalTitle = manga.PrimaryTitle;
        upscalerProfiles = await DbContext.UpscalerProfiles.ToListAsync();
    }

    private void AddAlternativeTitle()
    {
        if (!string.IsNullOrEmpty(newTitle) && manga is not null)
        {
            manga.OtherTitles.Add(new MangaAlternativeTitle
            {
                Title = newTitle,
                MangaId = manga.Id,
                Manga = manga
            });
            newTitle = string.Empty; // Clear the input field
        }
    }


    private async Task Save()
    {
        if (manga is null)
        {
            return;
        }

        await form.Validate();
        if (!isValid)
        {
            Snackbar.Add("Please fix the errors in the form.", Severity.Error);
            return;
        }

        try
        {
            if (manga.PrimaryTitle != originalTitle)
            {
                var newTitle = manga.PrimaryTitle;
                manga.PrimaryTitle = originalTitle;
                var result = await MetadataChanger.ChangeMangaTitle(manga, newTitle, addOldTitleToOtherTitles);
                if (result is not RenameResult.Ok)
                {
                    Snackbar.Add("Failed to change manga title.", Severity.Error);
                    return;
                }
            }

            await DbContext.SaveChangesAsync();

            Snackbar.Add("Manga updated successfully.", Severity.Success);
            NavigationManager.NavigateTo("/mangas");
        }
        catch (Exception e)
        {
            Snackbar.Add($"Error: {e.Message}", Severity.Error);
            Logger.LogError(e, "Error saving manga {MangaId}", manga.Id);
        }
    }

}
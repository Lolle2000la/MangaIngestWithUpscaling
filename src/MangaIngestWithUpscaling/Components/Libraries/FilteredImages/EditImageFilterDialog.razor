@using MangaIngestWithUpscaling.Data.LibraryManagement
@using Microsoft.Extensions.Localization
@using MangaIngestWithUpscaling.Resources
@inject ApplicationDbContext DbContext
@inject IStringLocalizer<EditImageFilterDialog> Loc
@inject IStringLocalizer<SharedResource> SharedLoc

<MudDialog>
    <TitleContent>@Loc["Title"]</TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @if (!string.IsNullOrEmpty(FilteredImage.ThumbnailBase64))
            {
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudImage Src="@($"data:{FilteredImage.MimeType};base64,{FilteredImage.ThumbnailBase64}")"
                                Width="150" Height="150" ObjectFit="ObjectFit.Cover" Class="rounded" />
                            <MudText Typo="Typo.body2" Align="Align.Center">
                                @FilteredImage.OriginalFileName
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }

            <MudTextField @bind-Value="FilteredImage.Description" Label="@Loc["Label_Description"]"
                Placeholder="@Loc["Placeholder_Description"]" Lines="3" />

            <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center">
                @if (FilteredImage.FileSizeBytes.HasValue)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @string.Format(Loc["Text_Size"], FormatFileSize(FilteredImage.FileSizeBytes.Value))
                    </MudText>
                }

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @string.Format(Loc["Text_Added"], FilteredImage.DateAdded.ToString("yyyy-MM-dd"))
                </MudText>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @string.Format(Loc["Text_Occurrences"], FilteredImage.OccurrenceCount)
                </MudText>

                @if (FilteredImage.LastMatchedAt.HasValue)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @string.Format(Loc["Text_LastMatched"], FilteredImage.LastMatchedAt.Value.ToString("yyyy-MM-dd"))
                    </MudText>
                }
            </MudStack>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@SharedLoc["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">
            @SharedLoc["Save"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance DialogReference { get; set; } = null!;
    [Parameter] public FilteredImage FilteredImage { get; set; } = null!;

    private async Task Submit()
    {
        try
        {
            // Ensure the description update is persisted even if the entity is detached
            var entry = DbContext.Entry(FilteredImage);
            if (entry.State == EntityState.Detached)
            {
                DbContext.Attach(FilteredImage);
                entry = DbContext.Entry(FilteredImage);
            }

            // Mark only the Description property as modified
            entry.Property(nameof(FilteredImage.Description)).IsModified = true;
            await DbContext.SaveChangesAsync();

            DialogReference.Close(DialogResult.Ok(true));
        }
        catch
        {
            DialogReference.Close(DialogResult.Cancel());
        }
    }
    private void Cancel() => DialogReference?.Close(DialogResult.Cancel());

    private static string FormatFileSize(long bytes)
    {
        string[] suffixes = ["B", "KB", "MB", "GB"];
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:n1} {suffixes[counter]}";
    }
}
@page "/libraries/{LibraryId:int}/filtered-images"
@using MangaIngestWithUpscaling.Data.LibraryManagement
@using MangaIngestWithUpscaling.Services.BackgroundTaskQueue
@using MangaIngestWithUpscaling.Services.BackgroundTaskQueue.Tasks
@using MangaIngestWithUpscaling.Services.ImageFiltering
@using Microsoft.Extensions.Localization
@using MangaIngestWithUpscaling.Shared.Helpers
@using Humanizer
@using System.Globalization

@inject ApplicationDbContext DbContext
@inject IDialogService DialogService
@inject ITaskQueue TaskQueue
@inject IImageFilterService ImageFilterService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IStringLocalizer<FilteredImages> Loc
@inject IStringLocalizer<SharedResource> SharedLoc

<PageTitle>@string.Format(Loc["PageTitle"], Library?.Name ?? SharedLoc["Loading"])</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <a href="libraries">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" />
            </a>
            <MudText Typo="Typo.h5">@string.Format(Loc["Header_Title"], Library?.Name ?? SharedLoc["Loading"])</MudText>
        </MudStack>
    </MudCardHeader>
    <MudCardContent>
        @if (Library == null)
        {
            <MudSkeleton />
        }
        else
        {
            <MudStack Spacing="3">
                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
                            OnClick="ShowAddFilterDialog">
                            @Loc["Button_AddFilter"]
                        </MudButton>
                        <MudButton StartIcon="@Icons.Material.Filled.PlayArrow" Variant="Variant.Outlined"
                            Color="Color.Secondary" OnClick="ApplyFiltersRetroactively"
                            Disabled="@(!Library.FilteredImages.Any())">
                            @Loc["Button_ApplyRetroactively"]
                        </MudButton>
                        <MudSpacer />
                        <MudTextField @bind-Value="searchString" @bind-Value:after="@(() => table.ReloadServerData())"
                            Placeholder="@SharedLoc["Search"]" Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Immediate="true"
                            Clearable="true" />
                    </MudStack>
                </MudPaper>

                <MudTable @ref="table" T="FilteredImage" ServerData="LoadFilteredImages" Dense="true" Hover="true"
                    FixedHeader="true" Height="600px">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">
                            @if (Library.FilteredImages.Any())
                            {
                                <span>@string.Format(Loc["Text_FilteredImagesCount"],
                                                                Loc["Word_FilteredImage"].Value.ToLocalizedQuantity(Library.FilteredImages.Count,
                                                                CultureInfo.CurrentUICulture))</span>
                                                }
                            else
                            {
                                <span>@Loc["Text_NoFilteredImages"]</span>
                            }
                        </MudText>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="thumbnail">@Loc["Header_Preview"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="filename">@Loc["Header_Filename"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="description">@Loc["Header_Description"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="date_added">@Loc["Header_Added"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="occurrences">@Loc["Header_Occurrences"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel T="FilteredImage" SortLabel="last_matched">@Loc["Header_LastMatched"]
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>@SharedLoc["Actions"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="@Loc["Header_Preview"]">
                            @if (!string.IsNullOrEmpty(context.ThumbnailBase64))
                            {
                                <MudImage Src="@($"data:{context.MimeType};base64,{context.ThumbnailBase64}")" Width="64"
                                    Height="64" ObjectFit="ObjectFit.Cover" Class="rounded cursor-pointer"
                                    @onclick="() => ShowImagePreview(context)" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" />
                            }
                        </MudTd>
                        <MudTd DataLabel="@Loc["Header_Filename"]">
                            <MudText Typo="Typo.body2">@context.OriginalFileName</MudText>
                            @if (context.FileSizeBytes.HasValue)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @FormatFileSize(context.FileSizeBytes.Value)</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="@Loc["Header_Description"]">
                            @if (!string.IsNullOrEmpty(context.Description))
                            {
                                <MudText Typo="Typo.body2">@context.Description</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Loc["Text_NoDescription"]</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="@Loc["Header_Added"]">
                            <MudText Typo="Typo.body2">@context.DateAdded.ToString("yyyy-MM-dd")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.DateAdded.ToString("HH:mm")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="@Loc["Header_Occurrences"]">
                            <MudChip T="string" Color="@(context.OccurrenceCount > 0 ? Color.Success : Color.Default)"
                                Size="Size.Small">
                                @context.OccurrenceCount
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="@Loc["Header_LastMatched"]">
                            @if (context.LastMatchedAt.HasValue)
                            {
                                <MudText Typo="Typo.body2">@context.LastMatchedAt.Value.ToString("yyyy-MM-dd")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @context.LastMatchedAt.Value.ToString("HH:mm")</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@Loc["Text_Never"]</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="@SharedLoc["Actions"]">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                OnClick="() => EditFilter(context)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                OnClick="() => DeleteFilter(context)" />
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Align="Align.Center" Typo="Typo.h6" Color="Color.Secondary">
                            @Loc["NoRecords_Title"]
                        </MudText>
                        <MudText Align="Align.Center" Typo="Typo.body1" Color="Color.Secondary">
                            @Loc["NoRecords_Subtitle"]
                        </MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            </MudStack>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public int LibraryId { get; set; }

    private Library? Library;
    private MudTable<FilteredImage> table = null!;
    private string searchString = "";

    protected override async Task OnInitializedAsync()
    {
        Library = await DbContext.Libraries
        .Include(l => l.FilteredImages)
        .FirstOrDefaultAsync(l => l.Id == LibraryId);

        if (Library == null)
        {
            NavigationManager.NavigateTo("/libraries");
        }
    }

    private Task<TableData<FilteredImage>> LoadFilteredImages(TableState state, CancellationToken cancellationToken)
    {
        if (Library == null) return Task.FromResult(new TableData<FilteredImage> { Items = [], TotalItems = 0 });

        var query = Library.FilteredImages.AsQueryable();

        // Apply search filter
        if (!string.IsNullOrEmpty(searchString))
        {
            var search = searchString.Trim().ToLowerInvariant();
            query = query.Where(f =>
            f.OriginalFileName.ToLower().Contains(search) ||
            (f.Description != null && f.Description.ToLower().Contains(search)));
        }

        // Apply sorting
        query = state.SortLabel switch
        {
            "filename" => query.OrderByDirection(state.SortDirection, f => f.OriginalFileName),
            "description" => query.OrderByDirection(state.SortDirection, f => f.Description ?? ""),
            "date_added" => query.OrderByDirection(state.SortDirection, f => f.DateAdded),
            "occurrences" => query.OrderByDirection(state.SortDirection, f => f.OccurrenceCount),
            "last_matched" => query.OrderByDirection(state.SortDirection, f => f.LastMatchedAt ?? DateTime.MinValue),
            _ => query.OrderByDescending(f => f.DateAdded)
        };

        var totalItems = query.Count();
        var items = query.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();

        return Task.FromResult(new TableData<FilteredImage> { Items = items, TotalItems = totalItems });
    }

    private async Task ShowAddFilterDialog()
    {
        var parameters = new DialogParameters { ["Library"] = Library! };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddImageFilterDialog>(Loc["Button_AddFilter"], parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await table.ReloadServerData();
            Snackbar.Add(Loc["Snackbar_FilterAdded"], Severity.Success);
        }
    }

    private async Task ShowImagePreview(FilteredImage filteredImage)
    {
        var parameters = new DialogParameters { ["FilteredImage"] = filteredImage };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Large
        };

        await DialogService.ShowAsync<ImagePreviewDialog>(Loc["DialogTitle_ImagePreview"], parameters, options);
    }

    private async Task EditFilter(FilteredImage filteredImage)
    {
        var parameters = new DialogParameters { ["FilteredImage"] = filteredImage };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<EditImageFilterDialog>(Loc["DialogTitle_EditFilter"], parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await DbContext.SaveChangesAsync();
            await table.ReloadServerData();
            Snackbar.Add(Loc["Snackbar_FilterUpdated"], Severity.Success);
        }
    }

    private async Task DeleteFilter(FilteredImage filteredImage)
    {
        var confirm = await DialogService.ShowMessageBox(
        SharedLoc["ConfirmDelete"],
        string.Format(Loc["DialogContent_DeleteConfirm"], filteredImage.OriginalFileName),
        yesText: SharedLoc["Delete"], cancelText: SharedLoc["Cancel"]);

        if (confirm == true)
        {
            Library!.FilteredImages.Remove(filteredImage);
            DbContext.FilteredImages.Remove(filteredImage);
            await DbContext.SaveChangesAsync();
            await table.ReloadServerData();
            Snackbar.Add(Loc["Snackbar_FilterDeleted"], Severity.Success);
        }
    }

    private async Task ApplyFiltersRetroactively()
    {
        var confirm = await DialogService.ShowMessageBox(
        Loc["DialogTitle_ApplyRetroactively"],
        string.Format(Loc["DialogContent_ApplyRetroactively"], Library!.Name),
        yesText: Loc["Button_ApplyFilters"], cancelText: SharedLoc["Cancel"]);

        if (confirm == true)
        {
            var task = new ApplyImageFiltersTask
            {
                LibraryId = LibraryId,
                OnlyUnprocessed = false
            };

            await TaskQueue.EnqueueAsync(task);
            Snackbar.Add(Loc["Snackbar_TaskQueued"], Severity.Info);
        }
    }

    private static string FormatFileSize(long bytes)
    {
        string[] suffixes = ["B", "KB", "MB", "GB"];
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:n1} {suffixes[counter]}";
    }
}
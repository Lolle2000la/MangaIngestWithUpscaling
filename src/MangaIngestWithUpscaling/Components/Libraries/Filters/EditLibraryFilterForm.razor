@using MangaIngestWithUpscaling.Data.LibraryManagement
@using Microsoft.Extensions.Localization
@using System.Text.RegularExpressions
@inject IStringLocalizer<EditLibraryFilterForm> Loc
<MudTd DataLabel="@Loc["Label_PatternToMatch"]">
    <MudTextField Immediate="true" Required="true" @bind-Value="FilterRule.Pattern" 
                  Error="@IsPatternInvalid" ErrorText="@PatternErrorText" />
</MudTd>
<MudTd DataLabel="@Loc["Label_PatternType"]">
    <MudSelect Immediate="true" T="LibraryFilterPatternType" @bind-Value="FilterRule.PatternType">
        <MudSelectItem Value="LibraryFilterPatternType.Contains">@Loc["Option_Contains"]</MudSelectItem>
        <MudSelectItem Value="LibraryFilterPatternType.Regex">@Loc["Option_Regex"]</MudSelectItem>
    </MudSelect>
</MudTd>
<MudTd DataLabel="@Loc["Label_TargetField"]">
    <MudSelect Immediate="true" T="LibraryFilterTargetField" @bind-Value="FilterRule.TargetField">
        <MudSelectItem Value="LibraryFilterTargetField.MangaTitle">@Loc["Option_MangaTitle"]</MudSelectItem>
        <MudSelectItem Value="LibraryFilterTargetField.ChapterTitle">@Loc["Option_ChapterTitle"]
        </MudSelectItem>
        <MudSelectItem Value="LibraryFilterTargetField.FilePath">@Loc["Option_FilePath"]</MudSelectItem>
    </MudSelect>
</MudTd>
<MudTd DataLabel="@Loc["Label_Action"]">
    <MudSelect Immediate="true" T="FilterAction" @bind-Value="FilterRule.Action">
        <MudSelectItem Value="FilterAction.Include">@Loc["Option_Include"]</MudSelectItem>
        <MudSelectItem Value="FilterAction.Exclude">@Loc["Option_Exclude"]</MudSelectItem>
    </MudSelect>
</MudTd>

@code {
    [Parameter] public required LibraryFilterRule FilterRule { get; set; }
    
    private bool IsPatternInvalid => 
        FilterRule.PatternType == LibraryFilterPatternType.Regex && 
        !string.IsNullOrWhiteSpace(FilterRule.Pattern) && 
        !IsValidRegex(FilterRule.Pattern);
    
    private string? PatternErrorText => IsPatternInvalid ? (Loc["Error_InvalidRegex"].Value ?? "Invalid regular expression pattern") : null;
    
    private static bool IsValidRegex(string pattern)
    {
        if (string.IsNullOrWhiteSpace(pattern))
            return true;
        
        try
        {
            _ = Regex.Match("", pattern);
            return true;
        }
        catch (ArgumentException)
        {
            return false;
        }
    }
}
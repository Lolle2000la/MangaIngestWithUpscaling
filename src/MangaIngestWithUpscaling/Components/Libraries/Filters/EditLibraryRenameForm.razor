@using MangaIngestWithUpscaling.Data.LibraryManagement
@using Microsoft.Extensions.Localization
@using System.Text.RegularExpressions
@inject IStringLocalizer<EditLibraryRenameForm> Loc

<MudTd DataLabel="@Loc["Label_Pattern"]">
    <MudTextField Immediate="true" Required="true" Value="@RenameRule.Pattern"
        ValueChanged="@((string val) => { RenameRule.Pattern = val; RulesChanged.InvokeAsync(); })"
        Error="@IsPatternInvalid" ErrorText="@PatternErrorText" />
</MudTd>
<MudTd DataLabel="@Loc["Label_PatternType"]">
    <MudSelect Immediate="true" T="LibraryRenamePatternType" Value="@RenameRule.PatternType"
        ValueChanged="@((LibraryRenamePatternType val) => { RenameRule.PatternType = val; RulesChanged.InvokeAsync(); })">
        <MudSelectItem Value="LibraryRenamePatternType.Contains">@Loc["Option_Contains"]</MudSelectItem>
        <MudSelectItem Value="LibraryRenamePatternType.Regex">@Loc["Option_Regex"]</MudSelectItem>
    </MudSelect>
</MudTd>
<MudTd DataLabel="@Loc["Label_TargetField"]">
    <MudSelect Immediate="true" T="LibraryRenameTargetField" Value="@RenameRule.TargetField"
        ValueChanged="@((LibraryRenameTargetField val) => { RenameRule.TargetField = val; RulesChanged.InvokeAsync(); })">
        <MudSelectItem Value="LibraryRenameTargetField.SeriesTitle">@Loc["Option_SeriesTitle"]</MudSelectItem>
        <MudSelectItem Value="LibraryRenameTargetField.FileName">@Loc["Option_FileName"]</MudSelectItem>
        <MudSelectItem Value="LibraryRenameTargetField.ChapterTitle">@Loc["Option_ChapterTitle"]</MudSelectItem>
    </MudSelect>
</MudTd>
<MudTd DataLabel="@Loc["Label_Replacement"]">
    <MudTextField Immediate="true" Value="@RenameRule.Replacement"
        ValueChanged="@((string val) => { RenameRule.Replacement = val; RulesChanged.InvokeAsync(); })" />
</MudTd>

@code {
    [Parameter, EditorRequired] public required LibraryRenameRule RenameRule { get; set; }
    [Parameter] public EventCallback RulesChanged { get; set; }
    
    private bool IsPatternInvalid => 
        RenameRule.PatternType == LibraryRenamePatternType.Regex && 
        !string.IsNullOrWhiteSpace(RenameRule.Pattern) && 
        !IsValidRegex(RenameRule.Pattern);
    
    private string? PatternErrorText => IsPatternInvalid ? (Loc["Error_InvalidRegex"].Value ?? "Invalid regular expression pattern") : null;
    
    private static bool IsValidRegex(string pattern)
    {
        if (string.IsNullOrWhiteSpace(pattern))
            return true;
        
        try
        {
            _ = Regex.Match("", pattern);
            return true;
        }
        catch (ArgumentException)
        {
            return false;
        }
    }
}
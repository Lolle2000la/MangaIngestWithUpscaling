@page "/libraries"
@using MangaIngestWithUpscaling.Data.LibraryManagement
@using MangaIngestWithUpscaling.Services.BackgroundTaskQueue
@using MangaIngestWithUpscaling.Services.BackgroundTaskQueue.Tasks
@using MangaIngestWithUpscaling.Shared.Helpers
@using Humanizer
@using System.Globalization


@inject ApplicationDbContext DbContext
@inject IDialogService DialogService
@inject TaskQueue TaskQueue
@inject IStringLocalizer<Libraries> Loc
@inject IStringLocalizer<SharedResource> SharedLoc

<PageTitle>@Loc["PageTitle"]</PageTitle>

<MudGrid>
    <MudItem xs="12">
        <div class="d-flex align-center justify-space-between flex-wrap gap-4 mb-6">
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Color="Color.Primary" Size="Size.Large"
                    Class="mr-3" />
                <MudText Typo="Typo.h3" Color="Color.Primary">@Loc["Title"]</MudText>
            </div>
            <MudStack Row Spacing="2">
                <MudButton Href="libraries/create" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled"
                    Color="Color.Primary" Size="Size.Large">
                    @Loc["CreateLibrary"]
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.ImageAspectRatio" Variant="Variant.Outlined"
                    Color="Color.Secondary" Size="Size.Large" OnClick="OnUpscaleAll">
                    @Loc["UpscaleAll"]
                </MudButton>
            </MudStack>
        </div>
    </MudItem>

    <MudItem xs="12">
        @if (!LoadedLibraries.Any())
        {
            <MudPaper Elevation="0" Class="pa-8 text-center" Style="border: 2px dashed;">
                <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Large" Color="Color.Surface" Class="mb-4" />
                <MudText Typo="Typo.h5" Color="Color.Surface" Class="mb-2">@Loc["NoLibrariesYet"]</MudText>
                <MudText Typo="Typo.body1" Color="Color.Surface" Class="mb-4">
                    @Loc["CreateFirstLibraryDescription"]
                </MudText>
                <MudButton Href="libraries/create" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled"
                    Color="Color.Primary" Size="Size.Large">
                    @Loc["CreateYourFirstLibrary"]
                </MudButton>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="2">
                <MudTable T="Library" Items="@LoadedLibraries" FixedHeader="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6" Class="mr-4">@Loc["LibraryOverview"]</MudText>
                        <MudSpacer />
                        <MudText Typo="Typo.body2" Color="Color.Surface">
                            @string.Format(Loc["Stats_Libraries"],
                            Loc["Word_Library"].Value.ToLocalizedQuantity(LoadedLibraries.Count(),
                            CultureInfo.CurrentUICulture)) •
                            @string.Format(Loc["Stats_MangaSeries"],
                            Loc["Word_MangaSeries"].Value.ToLocalizedQuantity(LoadedLibraries.SelectMany(l => l.MangaSeries
                            ?? new List<Manga>()).Count(), CultureInfo.CurrentUICulture)) •
                            @string.Format(Loc["Stats_Chapters"],
                            Loc["Word_Chapter"].Value.ToLocalizedQuantity(LoadedLibraries.SelectMany(l => l.MangaSeries ??
                            new List<Manga>()).SelectMany(m => m.Chapters).Count(),
                            CultureInfo.CurrentUICulture))
                        </MudText>
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>
                        <MudText Typo="Typo.subtitle2">@Loc["Header_LibraryName"]</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.subtitle2">@Loc["Header_IngestPath"]</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.subtitle2">@Loc["Header_UpscalerConfig"]</MudText>
                    </MudTh>
                    <MudTh Style="text-align: center;">
                        <MudText Typo="Typo.subtitle2">@Loc["Header_MangaSeries"]</MudText>
                    </MudTh>
                    <MudTh Style="text-align: center;">
                        <MudText Typo="Typo.subtitle2">@Loc["Header_Chapters"]</MudText>
                    </MudTh>
                    <MudTh Style="text-align: center;">
                        <MudText Typo="Typo.subtitle2">@Loc["Header_Actions"]</MudText>
                    </MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="@Loc["Header_LibraryName"]">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" Class="mr-3" />
                            <div>
                                <MudText Typo="Typo.body1" Class="font-weight-medium">@context.Name</MudText>
                            </div>
                        </div>
                    </MudTd>

                    <MudTd DataLabel="@Loc["Header_IngestPath"]">
                        <MudTooltip Text="@context.IngestPath">
                            <MudText Typo="Typo.body2" Class="text-truncate">
                                @context.IngestPath
                            </MudText>
                        </MudTooltip>
                    </MudTd>

                    <MudTd DataLabel="@Loc["Header_UpscalerConfig"]">
                        <div class="d-flex flex-column gap-1">
                            @if (context.UpscalerProfile != null)
                                {
                                    <MudChip T="string" Icon="@Icons.Material.Filled.ImageAspectRatio" Color="Color.Info"
                                        Size="Size.Small">
                                        @context.UpscalerProfile.Name
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Surface">@Loc["NotConfigured"]</MudText>
                                }
                                @if (context.UpscaleOnIngest)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">
                                        @Loc["AutoUpscale"]
                                    </MudChip>
                                }
                            </div>
                        </MudTd>

                        <MudTd DataLabel="@Loc["Header_MangaSeries"]" Style="text-align: center;">
                            <MudText Typo="Typo.body1" Class="font-weight-medium">
                                @(context.MangaSeries?.Count() ?? 0)
                            </MudText>
                        </MudTd>

                        <MudTd DataLabel="@Loc["Header_Chapters"]" Style="text-align: center;">
                            <MudText Typo="Typo.body1" Class="font-weight-medium">
                                @(context.MangaSeries?.SelectMany(m => m.Chapters)?.Count() ?? 0)
                            </MudText>
                        </MudTd>

                        <MudTd DataLabel="@Loc["Header_Actions"]" Style="text-align: center;">
                            <MudStack Row Spacing="1" Justify="Justify.Center">
                                <MudTooltip Text="@Loc["Tooltip_Edit"]">
                                    <MudIconButton Href="@($"libraries/edit/{context.Id}")"
                                        Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" />
                                </MudTooltip>

                                <MudTooltip Text="@Loc["Tooltip_Scan"]">
                                    <MudIconButton Icon="@Icons.Material.Filled.Search" Color="Color.Info" Size="Size.Small"
                                        OnClick="@(e => OnScanLibrary(context))" />
                                </MudTooltip>

                                @if (context.UpscalerProfileId is not null &&
                                                            !string.IsNullOrEmpty(context.UpscaledLibraryPath))
                                {
                                    <MudTooltip Text="@Loc["Tooltip_Upscale"]">
                                        <MudIconButton Icon="@Icons.Material.Filled.ImageAspectRatio" Color="Color.Secondary"
                                            Size="Size.Small" OnClick="@(e => OnUpscaleLibrary(context))" />
                                    </MudTooltip>
                                }

                                <MudTooltip Text="@Loc["Tooltip_Integrity"]">
                                    <MudIconButton Icon="@Icons.Material.Filled.Checklist" Color="Color.Warning"
                                        Size="Size.Small" OnClick="@(e => OnCheckIntegrity(context))" />
                                </MudTooltip>

                                <MudTooltip Text="@Loc["Tooltip_Filters"]">
                                    <MudIconButton Href="@($"libraries/{context.Id}/filtered-images")"
                                        Icon="@Icons.Material.Filled.FilterAlt" Color="Color.Default" Size="Size.Small" />
                                </MudTooltip>

                                <MudTooltip Text="@Loc["Tooltip_Delete"]">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                        Size="Size.Small" OnClick="@(e => OnDeleteLibraryEntry(context))" />
                                </MudTooltip>
                            </MudStack>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    </MudItem>
</MudGrid>

@code {
    private IReadOnlyCollection<Library> LoadedLibraries { get; set; } = new List<Library>();

    protected override async Task OnInitializedAsync()
    {
        LoadedLibraries = await DbContext.Libraries
        .Include(x => x.UpscalerProfile)
        .Include(x => x.MangaSeries)
        .ThenInclude(x => x.UpscalerProfilePreference)
        .Include(x => x.MangaSeries)
        .ThenInclude(x => x.Chapters)
        .ToListAsync();
    }

    private async Task OnLibraryChanged()
    {
        LoadedLibraries = await DbContext.Libraries.ToListAsync();
    }

    protected async Task OnScanLibrary(Library library)
    {
        await TaskQueue.EnqueueAsync(new ScanIngestTask
        {
            LibraryId = library.Id,
            LibraryName = library.Name
        });
    }

    protected async Task OnDeleteLibraryEntry(Library library)
    {
        var result = await DialogService.ShowMessageBox(
        Loc["DeleteDialog_Title"],
        Loc["DeleteDialog_Content"],
        SharedLoc["Generic_OK"], cancelText: SharedLoc["Generic_Cancel"],
        options: new DialogOptions
        {
            CloseButton = true,
            BackdropClick = true,
            CloseOnEscapeKey = true
        });

        if (result.HasValue && result.Value)
        {
            DbContext.Libraries.Remove(library);
            await DbContext.SaveChangesAsync();
        }

        await OnLibraryChanged();
    }

    protected async Task OnUpscaleLibrary(Library library)
    {
        if (library.UpscalerProfileId is null || library.UpscalerProfile == null ||
        string.IsNullOrEmpty(library.UpscaledLibraryPath))
        {
            return;
        }

        foreach (var manga in library.MangaSeries)
        {
            foreach (var chapter in manga.Chapters)
            {
                if (chapter.IsUpscaled)
                {
                    continue;
                }

                await TaskQueue.EnqueueAsync(new UpscaleTask(chapter));
            }
        }
    }

    protected async Task OnUpscaleAll()
    {
        foreach (var library in LoadedLibraries)
        {
            await OnUpscaleLibrary(library);
        }
    }

    protected async Task OnCheckIntegrity(Library library)
    {
        await TaskQueue.EnqueueAsync(new LibraryIntegrityCheckTask(library));
    }
}
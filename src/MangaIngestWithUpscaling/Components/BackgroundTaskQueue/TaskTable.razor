@using MangaIngestWithUpscaling.Data.BackgroundTaskQueue
@using MangaIngestWithUpscaling.Services.BackgroundTaskQueue.TaskDescribers
@inject IStringLocalizer<TaskTable> Loc
@inject ITaskDescriberFactory DescriberFactory

<MudTable T="PersistedTask" Items="@Tasks" RowsPerPage="10" Elevation="3" Dense="true" @ref="Table">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@Title</MudText>
        <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.Delete" Variant="Variant.Outlined" Color="Color.Primary"
            OnClick="OnClearFailed">@Loc["ClearFailed"]
        </MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.ClearAll" Variant="Variant.Filled" Color="Color.Primary"
            OnClick="OnClearCompleted">@Loc["ClearCompleted"]
        </MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>@Loc["Header_Name"]</MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<PersistedTask, object>(x => x.CreatedAt)">
                @Loc["Header_QueuedAt"]</MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<PersistedTask, object?>(x => x.ProcessedAt)">
                @Loc["Header_FinishedAt"]
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<PersistedTask, object>(x => x.Status)">@Loc["Header_Status"]
            </MudTableSortLabel>
        </MudTh>
        <MudTh>@Loc["Header_Actions"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="@Loc["Header_Name"]">
            <TaskTitle Task="@context.Data" />
        </MudTd>
        <MudTd DataLabel="@Loc["Header_QueuedAt"]">@context.CreatedAt.ToLocalTime()</MudTd>
        <MudTd DataLabel="@Loc["Header_FinishedAt"]">@(context.ProcessedAt is not null ?
                        context.ProcessedAt.Value.ToLocalTime() : "")
        </MudTd>
        <MudTd DataLabel="@Loc["Header_Status"]">
            @Loc[$"Status_{context.Status}"]
            @if (context.Status == PersistedTaskStatus.Processing && context.Data?.Progress is not null)
            {
                var p = context.Data.Progress;
                <div style="font-size: 0.85em; color: var(--mud-palette-text-secondary); margin-top: 2px;">
                    <TaskProgressStatus TaskData="@context.Data" Progress="@p" />
                </div>
            }
        </MudTd>
        <MudTd DataLabel="@Loc["Header_Actions"]" Style="white-space: nowrap">
            @if (context.Status == PersistedTaskStatus.Pending)
            {
                <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Variant="Variant.Text" Size="Size.Small"
                    OnClick="_ => OnRunNow.InvokeAsync(context)" />
            }
            else if (context.Status is PersistedTaskStatus.Failed or PersistedTaskStatus.Canceled)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" Variant="Variant.Text" Size="Size.Small"
                    OnClick="_ => OnRetryFailed.InvokeAsync(context)" />
            }
            @if (context.Status == PersistedTaskStatus.Processing)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Cancel" Variant="Variant.Text" Color="Color.Error"
                    Size="Size.Small" OnClick="_ => OnCancel.InvokeAsync(context)" />
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Text" Color="Color.Error"
                    Size="Size.Small" OnClick="_ => OnDelete.InvokeAsync(context)" />
            }
        </MudTd>
    </RowTemplate>
    <ChildRowContent>
        @if (context.Status == PersistedTaskStatus.Processing)
        {
            var p = context.Data?.Progress;
            <MudTd colspan="6" Class="pa-0">
                <div style="width: 100%; height: 4px;">
                    @if (p is null || p.IsIndeterminate || p.Total <= 0)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Style="height: 4px;" />
                    }
                    else
                    {
                        <MudProgressLinear Value="@(Math.Clamp((double)p.Current / p.Total * 100.0, 0, 100))"
                            Color="Color.Primary" Style="height: 4px;" />
                    }
                </div>
            </MudTd>
        }
    </ChildRowContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    [Parameter] public IReadOnlyCollection<PersistedTask> Tasks { get; set; } = [];
    [Parameter] public string Title { get; set; } = "Tasks";

    [Parameter] public EventCallback OnClearCompleted { get; set; } = EventCallback.Empty;
    [Parameter] public EventCallback OnClearFailed { get; set; } = EventCallback.Empty;
    [Parameter] public EventCallback<PersistedTask> OnRetryFailed { get; set; } = EventCallback<PersistedTask>.Empty;
    [Parameter] public EventCallback<PersistedTask> OnCancel { get; set; } = EventCallback<PersistedTask>.Empty;
    [Parameter] public EventCallback<PersistedTask> OnRunNow { get; set; } = EventCallback<PersistedTask>.Empty;
    [Parameter] public EventCallback<PersistedTask> OnDelete { get; set; } = EventCallback<PersistedTask>.Empty;

    private MudTable<PersistedTask> Table { get; set; } = null!;

    protected override void OnParametersSet()
    {
        Tasks = new List<PersistedTask>(Tasks);
    }

}